---
title: "FGD Learnability Analysis"
output: html_notebook
---

```{r, message=FALSE}
library(tidyverse)
library(brms)
library(lme4)
library(lmerTest)
library(plotrix)
library(stringr)
library(readxl)
library(VGAM)
library(jsonlite)
library(viridis)
library(broom)
#library(Cairo)

```

### Read in Data

```{r}
df = read.csv("../data/combined_results_llama.csv") %>%
  dplyr::select(-X)
```

### Incorporating New Gender Controls

```{r}

GRNN = read.csv("../data/gender_suppl_tests/results/GRNN.txt", sep="\t") %>% rename("GRNN" = "surprisal") %>% filter(token != "<eos>", token != ".") %>% select(-token)

GPT2 = read.csv("../data/gender_suppl_tests/results/GPT2.txt", sep="\t") %>% rename("GPT2" = "surprisal") %>% filter(! token %in% c("Ġ<", "Ġ<e", "Ġos", "Ġ>", "Ġ.", "<", "e", "os", ">", ".")) %>%
  mutate(medial = if_else(GPT2 > 0 & !str_detect(token, "^Ġ"), T, F))%>%
  mutate(
    b1_tok = lead(token),
    b1_surp = lead(GPT2),
    b1_medial = lead(medial),
    
    b2_tok = lead(b1_tok),
    b2_surp = lead(b1_surp),
    b2_medial = lead(b1_medial),
    b2_medial = (b1_medial & b2_medial)
    #Two-back is the furthest it goes
  ) %>%
  mutate(
    GPT2 = if_else(b1_medial == T, GPT2 + b1_surp, GPT2),
    GPT = if_else(b1_medial == T & b2_medial == T, GPT2 + b1_surp + b2_surp, GPT2)
  ) %>%
  filter(medial == F) %>%
  select(GPT2)

GPT3 = read.csv("../data/gender_suppl_tests/results/GPT3.txt", sep="\t") %>% rename("GPT3" = "surprisal") %>% mutate(GPT3 = if_else(is.na(GPT3), 0, -1 * GPT3)) %>% filter(token != "Ġ.") %>%
  mutate(medial = if_else(GPT3 > 0 & !str_detect(token, "^Ġ"), T, F)) %>%
    mutate(
      b1_tok = lead(token),
      b1_surp = lead(GPT3),
      b1_medial = lead(medial),
      
      b2_tok = lead(b1_tok),
      b2_surp = lead(b1_surp),
      b2_medial = lead(b1_medial),
      b2_medial = (b1_medial & b2_medial)
      #Two-back is the furthest it goes
    ) %>%
    mutate(
      GPT2 = if_else(b1_medial == T, GPT3 + b1_surp, GPT3),
      GPT = if_else(b1_medial == T & b2_medial == T, GPT3 + b1_surp + b2_surp, GPT3)
    ) %>%
    filter(medial == F) %>%
    select(GPT3)


JRNN = read.csv("../data/gender_suppl_tests/results/JRNN.txt", sep="\t") %>% rename("JRNN" = "surprisal") %>% filter(token != "<eos>", token != ".") %>% select(-token)
NGRAM = read.csv("../data/gender_suppl_tests/results/NGRAm.txt", sep="\t") %>% rename("NGRAM" = "surprisal") %>% filter(token != ".") %>% select(-token)
REF = read.csv("../data/gender_suppl_tests/test_items.csv", col.names = c("test", "item", "condition", "region", "token")) %>% filter(token != ".")

suppl_control_df = cbind(REF, GRNN, GPT2, GPT3, JRNN, NGRAM) %>%
  rename("sent_idx" = "token_id") %>%
  select(-sentence_id)

df = rbind(df, suppl_control_df)
df = df[c("test", "condition", "region", "token", "item", "sent_idx", "NGRAM", "GRNN", "JRNN", "GPT2", "GPT3")]

```

### Basic Licensing

```{r}
df_basic = df %>%
  filter((test == "basic_object") | (test == "basic_pp") | (test == "basic_subject")) %>%
  separate(condition, sep="_", into=c("wh", "gap")) %>%
  gather(model, surprisal, 8:13) %>%
  group_by(test, item, wh, gap, region, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  mutate(test=factor(test, levels=c("basic_subject", "basic_object", "basic_pp"))) %>%
  filter((test == "basic_subject" & region == "verb" & gap == "gap") | (test == "basic_subject" & region == "np1" & gap == "nogap") |
           (test == "basic_object" & region == "prep" & gap == "gap") | (test == "basic_object" & region == "np2" & gap == "nogap") |
           (test == "basic_pp" & region == "end" & gap == "gap") | (test == "basic_pp" & region == "np3" & gap == "nogap"))

df_basic %>%
    spread(wh, surprisal) %>%
    mutate(whf = what-that) %>%
    select(-that, -what) %>%
    group_by(model, test, item) %>%
      mutate(item_mean=mean(whf)) %>%
    ungroup() %>%
    group_by(model, test, gap) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
ggplot(aes(x=test, y=m, ymin=lower, ymax=upper, fill=gap)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    scale_x_discrete(labels= c("subject", "object", "prep phrase")) +
    ylab("Wh-Effect") +
    xlab("Gap Location") +
    ggtitle("Basic Filler-Gap Licensing") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.text.x= element_text(angle=45, hjust=1),
          axis.title=element_text(size=12),
          legend.title=element_blank())

ggsave("./images/basic_licensing.pdf", height=4,width=10, device = "pdf")

```

```{r}

REGION_ORDER = c("prefix", "apposotive", "np1", "verb", "np2", "prep", "np3", "end")
REGION_EXEMPLARS = c("I know\nthat/wh", "...", "the CEO", "showed", "the slides", "to", "the guests", "after lunch")
NUM_REGIONS = length(REGION_ORDER)

df_basic_regions = df %>%
  filter((test == "basic_object") | (test == "basic_pp") | (test == "basic_subject")) %>%
  mutate(region = as.character(region),
         region = if_else(region == "comp", "prefix", region)) %>%
  separate(condition, sep="_", into=c("wh", "gap")) %>%
  mutate(region = factor(region, levels = REGION_ORDER),
         gap = factor(gap, levels = c("nogap", "gap"))) %>%
  gather(model, surprisal, 8:13) %>%
  group_by(test, item, wh, gap, region, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  mutate(test=factor(test, levels=c("basic_subject", "basic_object", "basic_pp")))

annotations = data.frame(x1=c(3,4,5,6,7,8), x2=c(3,4,5,6,7,8), y1=c(0,0,0,0,0,0), y2=c(2,-3,3,-3,1.5,-2), test=c("subject-gap","subject-gap","object-gap","object-gap", "pp-gap", "pp-gap"))


df_basic_regions %>%
   mutate(test = str_replace(test, "basic_subject", "subject-gap"),
           test = str_replace(test, "basic_object", "object-gap"),
           test = str_replace(test, "basic_pp", "pp-gap"),
           test = factor(test, levels = c("subject-gap", "object-gap", "pp-gap"))) %>%
    spread(wh, surprisal) %>%
    mutate(whf = what-that) %>%
    select(-that, -what) %>%
    group_by(model, test, item, region) %>%
      mutate(item_mean=sum(whf)) %>%
    ungroup() %>%
    group_by(model, test, gap, region) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  mutate(region=as.numeric(region)) %>%
  # MODEL SELECTION
  filter(model == "JRNN") %>%
ggplot(aes(x=region, y=m, ymin=lower, ymax=upper, color=gap, linetype=gap)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_segment(data=annotations, aes(x=x1,y=y1,yend=y2,xend=x2), color="blue", alpha=0.5, arrow = arrow(length = unit(0.2, "cm")),inherit.aes=FALSE) +
    geom_line(size=1 ) +
    geom_errorbar(linetype="solid", width=.1, alpha=0.5) +
    scale_color_manual(labels = c("-gap", "+gap"), values = c("#f8766d", "#00bfc4")) +
    scale_x_continuous(breaks=seq(1, NUM_REGIONS), labels=REGION_EXEMPLARS) +
    guides(linetype=FALSE) +
    ylab("Wh-Effect") +
    xlab("Gap Location") +
    facet_grid(test~.) +
    ggtitle("Basic Filler-Gap Licensing (JRNN)") +
    theme(legend.position="right", 
          axis.text=element_text(size=10),
          axis.text.x= element_text(angle=45, hjust=1),
          axis.title=element_text(size=12),
          legend.title=element_blank())

ggsave("./images/basic_licensing_region.pdf",height=4.5,width=7, device = "pdf")



```

```{r}

df_basic_regions = df %>%
  filter((test == "basic_object") | (test == "basic_pp") | (test == "basic_subject")) %>%
  mutate(region = as.character(region),
         region = if_else(region == "comp", "prefix", region)) %>%
  separate(condition, sep="_", into=c("wh", "gap")) %>%
  mutate(region = factor(region, levels = REGION_ORDER),
         gap = factor(gap, levels = c("nogap", "gap"))) %>%
  gather(model, surprisal, 8:13) %>%
  group_by(test, item, wh, gap, region, model) %>%
    summarise(surprisal = mean(surprisal)) %>%
  ungroup() %>%
  mutate(test=factor(test, levels=c("basic_subject", "basic_object", "basic_pp")))

annotations1 = data.frame(x1=c(2.75, 4.75, 6.75), x2=c(3.25, 5.25, 7.25), y1=c(9, 6, 4.5), y2=c(13, 10, 7.5), test=c("subject-gap", "object-gap", "pp-gap"), gap = "-gap", "-gap", "-gap")
annotations2 = data.frame(x1=c(3.75, 5.75, 7.75), x2=c(4.25, 6.25, 8.25), y1=c(11.5, 4, 7), y2=c(18, 10, 11), test=c("subject-gap", "object-gap", "pp-gap"), gap = "+gap", "+gap", "+gap")

df_basic_regions %>%
    mutate(test = str_replace(test, "basic_subject", "subject-gap"),
           test = str_replace(test, "basic_object", "object-gap"),
           test = str_replace(test, "basic_pp", "pp-gap"),
           test = factor(test, levels = c("subject-gap", "object-gap", "pp-gap"))) %>%
    group_by(model, test, item, region) %>%
      mutate(item_mean=mean(surprisal)) %>%
    ungroup() %>%
    group_by(model, test, gap, wh, region) %>%
      summarise(m=mean(surprisal),
              s=std.error(surprisal - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  mutate(region=as.numeric(region)) %>%
  filter(model == "JRNN") %>%
  mutate(gap = if_else(gap=="nogap", "-gap", "+gap"),
         wh = if_else(wh=="that", "-filler", "+filler")) %>%
ggplot(aes(x=region, y=m, ymin=lower, ymax=upper, color=wh)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_rect(data=annotations1, aes(xmin=x1, xmax=x2, ymin=y1,ymax=y2), fill="#14fcf0", alpha=0.3, size=0.1, inherit.aes=FALSE) +
    geom_rect(data=annotations2, aes(xmin=x1, xmax=x2, ymin=y1,ymax=y2), fill="#14fcf0", alpha=0.3, size=0.1, inherit.aes=FALSE) +
    geom_line(size=0.8 ) +
    geom_errorbar(linetype="solid", width=.1, alpha=0.5) +
    facet_grid(test~gap) +
    scale_color_manual(labels = c("-filler", "+filler"), values = c("#7cae00", "#c77cff")) +
    scale_x_continuous(breaks=seq(1, NUM_REGIONS), labels=REGION_EXEMPLARS) +
    ylab("Mean by-word Surprisal in Region") +
    xlab("Gap Location") +
    ggtitle("Basic Filler-Gap Licensing: (JRNN)") +
    coord_cartesian(ylim=c(2.5,21)) +
    theme(legend.position="bottom", 
          axis.text=element_text(size=10),
          axis.text.x= element_text(angle=45, hjust=1),
          axis.title=element_text(size=12),
          legend.title=element_blank())

ggsave("./images/basic_licensing_region_rawsurp.pdf",height=7,width=7, device = cairo_pdf)

```



```{r}
options(scipen = 999)


stats_test = function(df, model) {
  print(model);
  df %>%
    summarise(
      e = summary(lmer(surprisal~wh*gap+(wh+gap||item), data = df))$coefficients[4],
      p = summary(lmer(surprisal~wh*gap+(wh+gap||item), data = df))$coefficients[20],

    )
}

df_basic %>%
  mutate(gap=factor(gap, levels=c("nogap", "gap")),
         gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1)) %>%
  group_by(test, model) %>%
    do(stats_test(., unique(.$model))) %>%
  arrange(model) %>%
  ungroup()
```




### Unboundedness

```{r}
df_unbound = df %>%
  filter(test == "embed1" | test == "embed2" | test == "embed3" | test == "embed4") %>%
  separate(condition, sep="_", into=c("wh", "gap")) %>%
  gather(model, surprisal, 8:13) %>%
  group_by(test, item, wh, gap, region, model) %>%
    summarise(surprisal = mean(surprisal)) %>%
  ungroup() %>%
  mutate(test=factor(test, levels=c("embed1", "embed2", "embed3", "embed4"))) %>%
  filter((gap == "gap" & region == "continuation") | (gap == "no-gap" & region == "Unnamed: 7") )



df_unbound %>%
  spread(wh, surprisal) %>%
  mutate(whf = what-that) %>%
  select(-that, -what) %>%
  drop_na() %>%
    group_by(model, region, item) %>%
      mutate(item_mean=mean(whf)) %>%
    ungroup() %>%
    group_by(model, test, gap) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
ggplot(aes(x=test, y=m, ymin=lower, ymax=upper, fill=gap)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    facet_grid(~model) +
    scale_x_discrete(labels= c("2", "3", "4", "5")) +
    ylab("Wh-Effect") +
    xlab("Layers of Embedding") +
    ggtitle("Unboundedness") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title=element_text(size=12),
          legend.title=element_blank())

ggsave("./images/unboundedness.pdf",height=4,width=10, , device = "pdf")

```

```{r}
stats_test = function(df, model) {
  print(model);
  df %>%
    summarise(
      e = summary(lmer(surprisal~wh*gap+(1+gap||item), data = df))$coefficients[4],
      p = summary(lmer(surprisal~wh*gap+(1+gap||item), data = df))$coefficients[20],

    )
}

df_unbound %>%
  mutate(gap=factor(gap, levels=c("no-gap", "gap")),
         gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1)) %>%
  group_by(test, model) %>%
    do(stats_test(., unique(.$model))) %>%
  arrange(model) %>%
  ungroup()

```

Testing whether there is a significant reduction in licensing between the various conditions.

```{r}

stats_test = function(df, model) {
  print(model);
  df %>%
    summarise(
      
      e1 = summary(lmer(surprisal~wh*gap*test+(gap||item), data = df))$coefficients[14],
      e2 = summary(lmer(surprisal~wh*gap*test+(gap||item), data = df))$coefficients[15],
      e3 = summary(lmer(surprisal~wh*gap*test+(gap||item), data = df))$coefficients[16],

      p1 = summary(lmer(surprisal~wh*gap*test+(gap||item), data = df))$coefficients[78],
      p2 = summary(lmer(surprisal~wh*gap*test+(gap||item), data = df))$coefficients[79],
      p3 = summary(lmer(surprisal~wh*gap*test+(gap||item), data = df))$coefficients[80],
    )
}


df_unbound %>%
  mutate(gap=factor(gap, levels=c("no-gap", "gap")),
         gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1),
         test = factor(test, levels = c("embed1", "embed2", "embed3", "embed4"))) %>%
  group_by(model) %>%
    do(stats_test(., unique(.$model))) %>%
  arrange(model) %>%
ungroup()


```


### Heirarchy

```{r}

df_heriarchy = df %>%
  filter(test == "hierarchy") %>%
  separate(condition, sep="_", into=c("wh", "gap", "test")) %>%
  gather(model, surprisal, 8:13) %>%
  group_by(test, item, wh, gap, region, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  mutate(test = factor(test, levels = c("subj", "matrix"))) %>%
  filter( (test == "matrix" & gap == "gap" & region == "continuation") | (test == "subj" & gap == "gap" & region == "filler") |
            (test == "matrix" & gap == "nogap" & region == "matrix_gap") | (test == "subj" & gap == "nogap" & region == "subject_gap"))

df_heriarchy %>%
  spread(wh, surprisal) %>%
  mutate(whf = what-that) %>%
  select(-that, -what) %>%
    group_by(model, item, test) %>%
      mutate(item_mean=mean(whf)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, gap, test) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
ggplot(aes(x=test, y=m, ymin=lower, ymax=upper, fill=gap)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    ylab("Wh-Effect") +
    xlab("Gap Location") +
    ggtitle("Hierarchy") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title=element_text(size=12),
          legend.title=element_blank())

ggsave("./images/heirarchy.pdf",height=4,width=10, device = "pdf")

```



```{r}
stats_test = function(df, model) {
  print(model);
  df %>%
    summarise(
      e = summary(lmer(surprisal~wh*gap*test+(1+test+gap|item), data = df))$coefficients[8],
      p = summary(lmer(surprisal~wh*gap*test+(1+test+gap|item), data = df))$coefficients[40]
    )
}


df_heriarchy %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1),
         test = if_else(test == "matrix", 1, -1)) %>%
  group_by(model) %>%
    do(stats_test(., unique(.$model))) %>%
  arrange(model) %>%
  ungroup()

```

### Unboundedness vs. Hierarchy Test

```{r}
df_unbound_comp_stat = df %>%
  rename(idx = word_idx) %>%
  filter(test == "embed1" | test == "embed2" | test == "embed3" | test == "embed4") %>%
  separate(condition, sep="_", into=c("wh", "gap")) %>%
  gather(model, surprisal, 8:13) %>%
  mutate(wh_idx = if_else(token == "who" | token == "what", idx, as.integer(0))) %>%
  group_by(item, model, test) %>% #Get the IDX of the wh-token (in conditions where we have a wh word)
    mutate(wh_idx = max(wh_idx)) %>%
  ungroup() %>%
  group_by(test, item, wh, gap, region, model, wh_idx) %>%
    summarise(surprisal = mean(surprisal),
              idx = min(idx)) %>%
  ungroup() %>%
  mutate(test=factor(test, levels=c("embed1", "embed2", "embed3", "embed4"))) %>%
  filter((gap == "gap" & region == "continuation") | (gap == "no-gap" & region == "Unnamed: 7") ) %>%
  mutate(dep_length = idx - wh_idx)

df_heriarchy_comp_stat = df %>%
  rename(idx = word_idx) %>%
  filter(test == "hierarchy") %>%
  separate(condition, sep="_", into=c("wh", "gap", "test")) %>%
  gather(model, surprisal, 8:13) %>%
  mutate(wh_idx = if_else(token == "who" | token == "what", idx, as.integer(0))) %>%
  group_by(item, model, test) %>% #Get the IDX of the wh-token (in conditions where we have a wh word)
    mutate(wh_idx = max(wh_idx)) %>%
  ungroup() %>%
  group_by(test, item, wh, gap, region, model, wh_idx) %>%
    summarise(surprisal = sum(surprisal),
              idx = min(idx)) %>%
  ungroup() %>%
  mutate(test = factor(test, levels = c("subj", "matrix"))) %>%
  filter( (test == "matrix" & gap == "gap" & region == "continuation") | (test == "subj" & gap == "gap" & region == "filler") |
            (test == "matrix" & gap == "nogap" & region == "matrix_gap") | (test == "subj" & gap == "nogap" & region == "subject_gap")) %>%
  mutate(dep_length = idx - wh_idx)

df_comp_stat =  rbind(df_heriarchy_comp_stat, df_unbound_comp_stat)
  
m = df_comp_stat %>%
  filter(model == "JRNN") %>%
  mutate(dist = if_else(test == "subj" | test == "embed1" | test == "embed2", -1, 1)) %>%
  mutate(unbound = if_else(test == "subj" | test == "matrix", -1, 1)) %>%
  mutate(gap = if_else(gap == "nogap", "no-gap", gap)) %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1)) %>%
  lmer(surprisal ~ wh * gap * dist * unbound + (wh + gap + dist + unbound || item), data = .)
summary(m)

m = df_comp_stat %>%
  filter(model == "GRNN") %>%
  mutate(dist = if_else(test == "subj" | test == "embed1" | test == "embed2", -1, 1)) %>%
  mutate(unbound = if_else(test == "subj" | test == "matrix", -1, 1)) %>%
  mutate(gap = if_else(gap == "nogap", "no-gap", gap)) %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1)) %>%
  lmer(surprisal ~ wh * gap * dist * unbound + (wh + gap + dist + unbound || item), data = .)
summary(m)

m = df_comp_stat %>%
  filter(model == "GPT2") %>%
  mutate(dist = if_else(test == "subj" | test == "embed1" | test == "embed2", -1, 1)) %>%
  mutate(unbound = if_else(test == "subj" | test == "matrix", -1, 1)) %>%
  mutate(gap = if_else(gap == "nogap", "no-gap", gap)) %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1)) %>%
  lmer(surprisal ~ wh * gap * dist * unbound + (wh + gap + dist + unbound || item), data = .)
summary(m)

m = df_comp_stat %>%
  filter(model == "GPT3") %>%
  mutate(dist = if_else(test == "subj" | test == "embed1" | test == "embed2", -1, 1)) %>%
  mutate(unbound = if_else(test == "subj" | test == "matrix", -1, 1)) %>%
  mutate(gap = if_else(gap == "nogap", "no-gap", gap)) %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1)) %>%
  lmer(surprisal ~ wh * gap * dist * unbound + (wh + gap + dist + unbound || item), data = .)
summary(m)

m = df_comp_stat %>%
  filter(model == "LLAMA") %>%
  mutate(dist = if_else(test == "subj" | test == "embed1" | test == "embed2", -1, 1)) %>%
  mutate(unbound = if_else(test == "subj" | test == "matrix", -1, 1)) %>%
  mutate(gap = if_else(gap == "nogap", "no-gap", gap)) %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1)) %>%
  lmer(surprisal ~ wh * gap * dist * unbound + (wh + gap + dist + unbound || item), data = .)
summary(m)

```

### Adjunct Islands

```{r}
df_adj = df %>%
  filter(test == "islands_adjunct") %>%
  separate(condition, sep="_", into=c("wh", "gap", "island")) %>%
  filter((gap == "gap" & region == "continuation") | (gap == "nogap" & region == "obj") ) %>%
  gather(model, surprisal, 9:14) %>%
  group_by(island, item, wh, gap, region, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() 

df_adj %>%
  spread(wh, surprisal) %>%
  mutate(whf = what-that) %>%
  select(-that, -what) %>%
  drop_na() %>%
    group_by(model, region, item) %>%
      mutate(item_mean=mean(whf)) %>%
    ungroup() %>%
    group_by(model, gap, island) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
ggplot(aes(x=island, y=m, ymin=lower, ymax=upper, fill=gap)) +
   theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    scale_x_discrete(labels= c("control", "island")) +
    ylab("Wh-Effect") +
    ggtitle("Adjunct Islands\nFiller-Gap Dependency") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title.x=element_blank(),
          legend.title=element_blank())

ggsave("./images/adjunct.pdf",height=2.8,width=10, device = "pdf")

```

```{r}

stats_test = function(df, model) {
  print(model);
  df %>%
    summarise(
      e = summary(lmer(surprisal~wh*gap*island+(gap+1||item), data = df))$coefficients[8],
      p = summary(lmer(surprisal~wh*gap*island+(gap+1||item), data = df))$coefficients[40]
    )
}


df_adj %>%
  mutate(gap = if_else(gap == "gap", 1, 0),
         wh = if_else(wh == "what", 1, 0),
         island = if_else(island == "gram", 0, 1)) %>%
  group_by(model) %>%
    do(stats_test(., unique(.$model))) %>%
  arrange(model) %>%
  ungroup()

```


### Complex NP Islands

```{r}
df_cnp = df %>%
  filter(test == "islands_cnp") %>%
  separate(condition, sep="_", into=c("wh", "gap", "island")) %>%
  gather(model, surprisal, 9:14) %>%
  group_by(island, item, wh, gap, region, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  filter((gap == "gap" & region == "continuation") | (gap == "nogap" & region == "rc_obj") )


df_cnp %>%
    spread(wh, surprisal) %>%
    mutate(whf = what-that) %>%
    select(-that, -what) %>%
    group_by(model, region, item) %>%
      mutate(item_mean=mean(whf)) %>%
    ungroup() %>%
    group_by(model, gap, island) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
ggplot(aes(x=island, y=m, ymin=lower, ymax=upper, fill=gap)) +
   theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    scale_x_discrete(labels= c("control", "that-comp", "wh-comp")) +
    ylab("Wh-Effect") +
    ggtitle("Complex NP Islands\nFiller-Gap Dependency") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.text.x=element_text(angle=30, hjust =1),
          axis.title.x=element_blank(),
          legend.title=element_blank())

ggsave("./images/cnp.pdf",height=3.3,width=10, device = "pdf")
```

```{r}
stats_test = function(df) {
  df %>%
    summarise(
      e_that = summary(lmer(surprisal~wh*gap*island+(gap||item), data = df))$coefficients[11],
      e_wh = summary(lmer(surprisal~wh*gap*island+(gap||item), data = df))$coefficients[12],

      p_that = summary(lmer(surprisal~wh*gap*island+(gap||item), data = df))$coefficients[59],
      p_wh = summary(lmer(surprisal~wh*gap*island+(gap||item), data = df))$coefficients[60])
  }

df_cnp %>%
  mutate(gap=factor(gap, levels=c("nogap", "gap")),
         gap = if_else(gap == "gap", 1, 0),
         wh = if_else(wh == "what", 1, 0)) %>%
  group_by(model) %>%
    do(stats_test(.)) %>%
  arrange(model) %>%
  ungroup()


```


### Coordination Islands

```{r}
df_coord = df %>%
  filter(item != 21) %>% #This because item 21 doesn't have conditions!
  filter(test == "islands_coordination") %>%
  separate(condition, sep="_", into=c("wh", "gap", "island")) %>%
  mutate(island = factor(island, levels = c("obj", "first", "second"))) %>%
  gather(model, surprisal, 9:14) %>%
  group_by(island, item, wh, gap, region, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  filter((island == "obj" & gap == "gap" & region == "continuation") | (island == "obj" & gap == "nogap" & (region == "conj1" | region == "and" | region == "conj2")) |
          (island == "first" & gap == "gap" & (region == "and" | region == "conj2")) | (island == "first" & gap == "nogap" & region == "conj1") |
          (island == "second" & gap == "gap" & region == "continuation") | (island == "second" & gap == "nogap" & region == "conj2")) %>%
  group_by(model, wh, gap, island, item) %>%
    mutate(surprisal = sum(surprisal)) %>%
  ungroup()


df_coord %>%
  spread(wh, surprisal) %>%
  mutate(whf = what-that) %>%
  select(-that, -what) %>%
    group_by(model, island, item) %>%
      mutate(item_mean=mean(whf)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, gap, island) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  
ggplot(aes(x=island, y=m, ymin=lower, ymax=upper, fill=gap)) +
   theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    scale_x_discrete(labels= c("control", "1st\n conjunct", "2nd\n conj")) +
    ylab("Wh-Effect") +
    ggtitle("Coordination Islands\nFiller-Gap Dependency") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title.x=element_blank(),
          legend.title=element_blank())

ggsave("./images/coord.pdf",height=2.8,width=10, device = "pdf")
```



```{r}
stats_test = function(df) {
  df %>%
    summarise(
      e = summary(lmer(surprisal~wh*gap*island+(1+gap||item), data = df))$coefficients[8],
      p = summary(lmer(surprisal~wh*gap*island+(1+gap||item), data = df))$coefficients[40])
  }

df_coord %>%
  filter(island == "obj" | island == "second") %>%
  mutate(gap=factor(gap, levels=c("nogap", "gap")),
         gap = if_else(gap == "gap", 1, 0),
         wh = if_else(wh == "what", 1, 0)) %>%
  group_by(model) %>%
    do(stats_test(.)) %>%
  arrange(model) %>%
ungroup()

```


### Left Branch Islands

```{r}
df_lb = df %>%
  filter(test == "islands_left-branch") %>%
  separate(condition, sep="_", into=c("wh", "gap", "island")) %>%
  mutate(island = factor(island, levels = c("obj", "lb"))) %>%
  gather(model, surprisal, 9:14) %>%
  group_by(island, item, wh, gap, region, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  filter((island == "obj" & gap == "gap" & region == "continuation") | (island == "obj" & gap == "nogap" & (region == "det" | region == "adj" | region == "obj" | region == "continuation")) |
          (island == "lb" & gap == "gap" & (region == "continuation" | region == "obj")) | (island == "lb" & gap == "nogap" & (region == "adj" | region == "obj")))


df_lb %>%
  spread(wh, surprisal) %>%
  mutate(whf = what-that) %>%
  select(-that, -what) %>%
    group_by(model, island, item) %>%
      mutate(item_mean=mean(whf)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, gap, island) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  
ggplot(aes(x=island, y=m, ymin=lower, ymax=upper, fill=gap)) +
   theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    scale_x_discrete(labels= c("control", "island")) +
    ylab("Wh-Effect") +
    ggtitle("Left Branch Islands\nFiller-Gap Dependency") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title.x=element_blank(),
          legend.title=element_blank())

ggsave("./images/left-branch.pdf",height=2.8,width=10, device = "pdf")
```

```{r}
stats_test = function(df) {
  df %>%
    summarise(
      e = summary(lmer(surprisal~wh*gap*island+(gap+island||item), data = df))$coefficients[8],
      p = summary(lmer(surprisal~wh*gap*island+(gap+island||item), data = df))$coefficients[40])
  }

df_lb %>%
  group_by(island, item, wh, gap, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  mutate(gap=factor(gap, levels=c("nogap", "gap")),
         gap = if_else(gap == "gap", 1, 0),
         wh = if_else(wh == "what", 1, 0),
         island = if_else(island=="obj", 0, 1)) %>%
  group_by(model) %>%
    do(stats_test(.)) %>%
  arrange(model) %>%
ungroup()
```

### Sentential Subject Islands

```{r}
df_ss = df %>%
  filter(test == "islands_ss") %>%
  separate(condition, sep="_", into=c("wh", "gap", "island")) %>%
  #mutate(island = factor(island, levels = c("obj", "lb"))) %>%
  gather(model, surprisal, 9:14) %>%
  group_by(island, item, wh, gap, region, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  filter((gap == "gap" & region == "continuation") | (gap=="nogap" & region=="obj"))


df_ss %>%
    spread(wh, surprisal) %>%
    mutate(whf = what-that) %>%
    select(-that, -what) %>%
    group_by(model, island, item) %>%
      mutate(item_mean=mean(whf)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, gap, island) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  
ggplot(aes(x=island, y=m, ymin=lower, ymax=upper, fill=gap)) +
   theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    scale_x_discrete(labels= c("control", "island")) +
    ylab("Wh-Effect") +
    ggtitle("Sentential Subject Islands\nFiller-Gap Dependency") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title.x=element_blank(),
          legend.title=element_blank())

ggsave("./images/sentential_subj.pdf",height=2.8,width=10, device = "pdf")
```

```{r}
stats_test = function(df) {
  df %>%
    summarise(
      e = summary(lmer(surprisal~wh*gap*island+(gap+island|item), data = df))$coefficients[8],
      p = summary(lmer(surprisal~wh*gap*island+(gap+island|item), data = df))$coefficients[40])
  }

df_ss %>%
  group_by(island, item, wh, gap, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  mutate(gap=factor(gap, levels=c("nogap", "gap")),
         gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1),
         island = if_else(island == "obj", -1, 1)) %>%
  group_by(model) %>%
    do(stats_test(.)) %>%
  arrange(model) %>%
ungroup()

```


### Subject Islands

```{r}
df_subj = df %>%
  filter(test == "islands_subject") %>%
  separate(condition, sep="_", into=c("wh", "gap", "island")) %>%
  gather(model, surprisal, 9:14) %>%
  group_by(island, item, wh, gap, region, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  filter((gap == "gap" & region == "continuation") | (gap=="nogap" & region=="obj"))


df_subj %>%
spread(wh, surprisal) %>%
  mutate(whf = what-that) %>%
  select(-that, -what) %>%
    group_by(model, island, item) %>%
      mutate(item_mean=mean(whf)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, gap, island) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  
ggplot(aes(x=island, y=m, ymin=lower, ymax=upper, fill=gap)) +
   theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    scale_x_discrete(labels= c("control", "island")) +
    ylab("Wh-Effect") +
    ggtitle("Subject Islands\nFiller-Gap Dependency") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title.x=element_blank(),
          legend.title=element_blank())

ggsave("./images/subj.pdf",height=2.8,width=10, device = "pdf")
```


```{r}
stats_test = function(df) {
  df %>%
    summarise(
      e = summary(lmer(surprisal~wh*gap*island+(gap+island||item), data = df))$coefficients[8],
      p = summary(lmer(surprisal~wh*gap*island+(gap+island||item), data = df))$coefficients[40])
  }

df_subj %>%
  group_by(island, item, wh, gap, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  mutate(gap=factor(gap, levels=c("nogap", "gap")),
         gap = if_else(gap == "gap", 1, 0),
         wh = if_else(wh == "what", 1, 0),
         island = if_else(island == "obj", 0, 1)) %>%
  group_by(model) %>%
    do(stats_test(.)) %>%
  arrange(model) %>%
ungroup()

```

### Wh Islands

```{r}
df_wh = df %>%
  filter(test == "islands_wh") %>%
  separate(condition, sep="_", into=c("wh", "gap", "island")) %>%
  filter(island != "that") %>%
  #mutate(island = factor(island, levels = c("obj", "lb"))) %>%
  gather(model, surprisal, 9:14) %>%
  group_by(island, item, wh, gap, region, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  filter((gap == "gap" & region == "continuation") | (gap=="nogap" & region=="embed_obj"))


write.csv(df_wh, "wh_islands.csv")

df_wh %>%
  spread(wh, surprisal) %>%
  mutate(whf = what-that) %>%
  select(-that, -what) %>%
    group_by(model, island, item) %>%
      mutate(item_mean=mean(whf)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, gap, island) %>%
      summarise(m=mean(whf),
              s=std.error(whf - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  
ggplot(aes(x=island, y=m, ymin=lower, ymax=upper, fill=gap)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    scale_x_discrete(labels= c("control", "island")) +
    scale_y_continuous(labels = scales::number_format(accuracy = 0.1)) +
    ylab("Wh-Effect") +
    #xlab("Gap Location") +
    ggtitle("Wh Islands\nFiller-Gap Dependency") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title.x=element_blank(),
          legend.title=element_blank())

ggsave("./images/wh.pdf",height=2.8,width=10, device = "pdf")
```


```{r}

stats_test = function(df) {
  df %>%
    summarise(
      e = summary(lmer(surprisal~wh*gap*island+(1+gap||item), data = df))$coefficients[8],
      p = summary(lmer(surprisal~wh*gap*island+(1+gap||item), data = df))$coefficients[40])
  }

df_wh %>%
  group_by(island, item, wh, gap, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  mutate(gap=factor(gap, levels=c("nogap", "gap")),
         gap = if_else(gap == "gap", 1, 0),
         wh = if_else(wh == "what", 1, 0),
         island = if_else(island == "nocomp", 0, 1)) %>%
  group_by(model) %>%
    do(stats_test(.)) %>%
  arrange(model) %>%
ungroup()


```

```{r}
effect_df = data.frame(
  	model_name = c("GPT2", "GPT3", "GRNN", "JRNN", "LLAMA"),
	  Adjunct = c(5.3371848636570558000, 5.1090646768809770961, 3.0545335243333036068, 6.0738857427858166105, 6.86646),
	  Complex_NP = c(4.5803629791230990875, 4.2899146890715540437, 2.7689102622015875355, 5.9525923247316825382, 6.193),
	  Coordination = c(8.2249527685344201444, 6.6653563130850699281, 8.2661566890776754235, 9.3086483806253781381, 9.50571),
	  Left_Branch = c(2.2516639377921134901, 5.3584103464002028616, 3.6353099256755054824, 4.1625028997661308594, 7.845),
	  Sentential_Subj = c(1.3585723645630769507, 2.6110664404761818602, 1.3510029088881994053, 4.8766840387667480528, 0.5231),
	  Subject = c(3.67268553714860779280, 4.34609290042826490463, 1.70132635804736098706, 3.87447574870150512893, 5.021),
  	Wh = c(4.6440742471410585424, 4.1495286532916511035, 6.9288595011457632111, 7.7575216918873195482, 6.04882)
) %>%
  gather(island, model_effect, 2:8)

sig_df = data.frame(
  	model_name = c("GPT2", "GPT3", "GRNN", "JRNN", "LLAMA"),
	  Adjunct = c("***", "***", "***", "***", "***"),
	  Complex_NP = c("***", "***", "***", "***", "***"),
	  Coordination = c("***", "***", "***", "***", "***"),
	  Left_Branch = c("N.S.", "**", "**", "*", "***"),
	  Sentential_Subj = c("N.S.", "*", "N.S.", "*", "*"),
	  Subject = c("***", "**", "N.S.", "*", "*"),
  	Wh = c("***", "***", "**", "**", "***")
) %>%
  gather(island, significance, 2:8)

summary_df = merge(effect_df, sig_df, by=c("island", "model_name"))

sig_scale = c("***" = "#293359", "**" = "#293359", "*" = "#293359", "N.S." = "#9898b5")

summary_df %>%
  ggplot(aes(x=island, y=model_name)) +
    theme_bw() +
    geom_tile(aes(fill = model_effect)) +
    geom_text(aes(color=significance, size=5, label=paste(significance, "\n", substr(model_effect, 0, 3), sep="")), label.padding = unit(0.5, "lines"), fontface = "bold") +
    scale_color_manual(values = sig_scale) +
    #scale_fill_viridis(begin = 0.75, end = 0.99) +
    scale_fill_gradient(low = "#ffffff", high = "#cccccc") +
    #scale_fill_gradient2(low = "blue", high = "white") +
    #geom_vline(xintercept = 8.5, color = "blue", size = 0.5) +
    ggtitle("Summary of Island Results: Effect Sizes and Significance") +
  theme(
    axis.title = element_blank(),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 30, hjust = 1),
    legend.position = "none"
  )

ggsave("./images/effect_size.pdf", width = 9, height = 4, device = "pdf")


```


## GENDER CONTROL


```{r}

plot_gender = function(df) {
  p = ggplot(df, aes(x=island, y=m, ymin=lower, ymax=upper, fill=lisc)) +
      geom_hline(yintercept=0, color="grey") +
      geom_bar(stat="identity", position="dodge") +
      geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
      facet_grid(~model) +
      theme_bw() +
      scale_fill_manual(labels = c("fem.", "masc."), values = c("#7cae00", "#c77cff")) +
      scale_x_discrete(labels= c("control", "island")) +
      ylab("Masc Expectation") +
      ggtitle("Gender Control") +
      theme(legend.position="right", 
            axis.text=element_text(size=12),
            axis.title.x=element_blank(),
            legend.title=element_blank())
    ggsave(p, filename=paste("./images/", unique(df$test), ".pdf", sep=""),height=2.8,width=10, device = cairo_pdf)
  return(df)
}

df_gender = df %>%
  filter(str_detect(test, "^gender")) %>%
  separate(condition, sep="_", into=c("lisc", "pron", "island")) %>%
  gather(model, surprisal, 9:13) %>%
  filter(region == "pronoun") %>%
  mutate(island = factor(island, levels = c("obj", "island"))) %>%
  select(-token)

#write_csv(df_gender, "./df_gender.csv")

df_gender %>%
  filter(! test %in% c("gender_cnp_wh", "gender_cnp")) %>%
  spread(pron, surprisal) %>%
  mutate(gend_exp = fem-male) %>%
  select(-fem, -male) %>%
    group_by(model, item, test) %>%
      mutate(item_mean=mean(gend_exp)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, test, island, lisc) %>%
      summarise(m=mean(gend_exp),
              s=std.error(gend_exp - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  mutate(model = factor(model, levels = c("GPT2", "GPT3", "GRNN", "JRNN", "NGRAM"))) %>%
  group_by(test) %>%
  do({ plot_gender(.) }) %>%
  ungroup()

```


### Coordination Gender Tests

```{r}
df %>%
  filter(test == "gender_coord" | test == "gender_coord_conj1") %>%
  separate(condition, sep="_", into=c("lisc", "pron", "island")) %>%
  gather(model, surprisal, 9:13) %>%
  filter(region == "pronoun") %>%
  select(-token) %>%
  spread(pron, surprisal) %>%
  mutate(gend_exp = fem-male) %>%
  select(-fem, -male) %>%
  group_by(model, item, test) %>%
    mutate(item_mean=mean(gend_exp)) %>%
  ungroup() %>%
  drop_na() %>%
  group_by(model, test, island, lisc) %>%
    summarise(m=mean(gend_exp),
            s=std.error(gend_exp),
            upper=m + 1.96*s,
            lower=m - 1.96*s) %>%
    ungroup() %>%
  mutate(island = if_else(test == "gender_coord_conj1" & island == "island", "conj1", island),
         island = if_else(test == "gender_coord" & island == "island", "conj2", island)) %>%
  filter(! (test == "gender_coord_conj1" & island == "obj")) %>%
  mutate(island = factor(island, levels = c("obj", "conj1", "conj2"))) %>%
   ggplot(aes(x=island, y=m, ymin=lower, ymax=upper, fill=lisc)) +
      geom_hline(yintercept=0, color="grey") +
      geom_bar(stat="identity", position="dodge") +
      geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
      facet_grid(~model) +
      theme_bw() +
      scale_fill_manual(labels = c("fem.", "masc."), values = c("#7cae00", "#c77cff")) +
      #scale_x_discrete(labels= c("control", "conj1")) +
      ylab("Masc Expectation") +
      ggtitle("Gender Control") +
      theme(legend.position="right", 
            axis.text.x=element_text(size=12, angle = 30, hjust=1),
            axis.title.x=element_blank(),
            legend.title=element_blank())

  ggsave(filename="./images/gender_coord.pdf",height=2.8,width=10, device = cairo_pdf)

```

### CNP Gender Tests

```{r}
df %>%
  filter(test == "gender_cnp" | test == "gender_cnp_wh") %>%
  separate(condition, sep="_", into=c("lisc", "pron", "island")) %>%
  gather(model, surprisal, 9:13) %>%
  filter(region == "pronoun") %>%
  select(-token) %>%
  spread(pron, surprisal) %>%
  mutate(gend_exp = fem-male) %>%
  select(-fem, -male) %>%
    group_by(model, item, test) %>%
      mutate(item_mean=mean(gend_exp)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, test, island, lisc) %>%
      summarise(m=mean(gend_exp),
              s=std.error(gend_exp - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  mutate(island = if_else(test == "gender_cnp" & island == "island", "that-cnp", island),
         island = if_else(test == "gender_cnp_wh" & island == "island", "wh-cnp", island)) %>%
  filter(! (test == "gender_cnp_wh" & island == "obj")) %>%
  mutate(island = factor(island, levels = c("obj", "that-cnp", "wh-cnp"))) %>%
   ggplot(aes(x=island, y=m, ymin=lower, ymax=upper, fill=lisc)) +
      geom_hline(yintercept=0, color="grey") +
      geom_bar(stat="identity", position="dodge") +
      geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
      facet_grid(~model) +
      theme_bw() +
      scale_fill_manual(labels = c("fem.", "masc."), values = c("#7cae00", "#c77cff")) +
      #scale_x_discrete(labels= c("control", "conj1")) +
      ylab("Masc Expectation") +
      ggtitle("Gender Control") +
      theme(legend.position="right", 
            axis.text.x=element_text(size=12, angle = 30, hjust=1),
            axis.title.x=element_blank(),
            legend.title=element_blank())
  
  ggsave(filename="./images/gender_cnp.pdf",height=2.8,width=10, device = cairo_pdf)

```

```{r}

stats_test = function(df) {
  df %>%
    summarise(
      e = summary(lmer(surprisal~lisc*pron*island+(1|item), data = df))$coefficients[8],
      p = summary(lmer(surprisal~lisc*pron*island+(1|item), data = df))$coefficients[40])
  }

df_gender %>%
  filter(! (model == "GPT3" & test == "gender_coord_conj1")) %>%
  filter(! (model == "GPT3" & test == "gender_cnp_whp")) %>%
  group_by(model, test) %>%
    do({stats_test(.)}) %>%
  arrange(test) %>%
ungroup()


```




## That Trace Effects

```{r}
df_trace = df %>%
  filter(test == "that_trace") %>%
  separate(condition, sep="_", into=c("wh", "gap", "comp", "gapsite")) %>%
  mutate(comp = if_else(comp == "noqcomp", "nocomp", comp)) %>%
  gather(model, surprisal, 10:14) %>%
  #mutate(model = factor(model, levels=c("NGRAM", "GRNN", "JRNN", "Trans.XL", "GPT2"))) %>%
  filter((gap == "gap" & region == "verb" & gapsite == "subj") | (gap == "no-gap" & gapsite == "subj" & region == "subj") |
         (gap == "gap" & region == "continuation" & gapsite == "obj") | (gap == "no-gap" & gapsite == "obj" & region == "obj" )) %>%
  group_by(gap, region, item, gapsite, wh, comp, model) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  select(-region)

df_trace %>%
  spread(wh, surprisal) %>%
  mutate(whef = what-that) %>%
  select(-what, -that) %>%
    group_by(model, item) %>%
      mutate(item_mean=mean(whef)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, gap, comp, gapsite) %>%
      summarise(m=mean(whef),
              s=std.error(whef - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  filter(gapsite == "subj") %>%
ggplot(aes(x=comp, y=m, ymin=lower, ymax=upper, fill=gap)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(gapsite~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    scale_x_discrete(labels= c("no-comp", "that-comp")) +
    ylab("Wh Effect") +
    xlab("Island") +
    ggtitle("That Trace Effects") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title=element_text(size=12),
          axis.title.x=element_blank(),
          legend.title=element_blank())
#ggsave("./images/that-trace.pdf",height=4,width=10, device = cairo_pdf)
```



### Region-by-region that-trace effects

```{r}
REGION_ORDER = c("prefix", "comp", "embedding", "comp.1", "subj", "verb", "obj", "continuation")
REGION_EXEMPLARS = c("I know", "who/that", "the count believes", "that", "the writer", "insulted", "the diplomat", "yesterday")
NUM_REGIONS = length(REGION_ORDER)

df_trace_region = df %>%
  filter(test == "that_trace") %>%
  
  separate(condition, sep="_", into=c("wh", "gap", "comp", "gapsite")) %>%
  mutate(comp = if_else(comp == "noqcomp", "nocomp", comp)) %>%
  mutate(region = factor(region, levels = REGION_ORDER)) %>%
  gather(model, surprisal, 10:14) %>%
  group_by(gap, region, item, gapsite, wh, comp, model) %>%
    summarise(surprisal = mean(surprisal)) %>%
  ungroup() %>%
  mutate(gap=factor(gap, levels=c("no-gap", "gap")),
         gapsite=factor(gapsite, levels=c("subj", "obj"), labels = c("subject gap", "object gap")),
         comp = factor(comp, levels=c("nocomp", "thatcomp"), labels = c("no compl.", "`that` compl.")))

annotations_subjgap = data.frame(x1=c(5,5,6,6), x2=c(5,5,6,6), y1=c(0,0,0,0), y2=c(0.5,0.2,-2.5,-2.5), comp=c("no compl.", "`that` compl.","no compl.", "`that` compl."), gapsite=c("subject gap", "subject gap","subject gap", "subject gap"))
annotations_objgap = data.frame(x1=c(7,7,8,8), x2=c(7,7,8,8), y1=c(0,0,0,0), y2=c(1.5,1,-1.5,-1.5), comp=c("no compl.", "`that` compl.","no compl.", "`that` compl."), gapsite=c("object gap", "object gap","object gap", "object gap"))
text_annotations = data.frame(text=c("Expected reduction in wh-effects."), x=c(5), y=c(-6), comp=c("`that` compl."), gapsite=c("subject gap"))

df_trace_region %>%
    spread(wh, surprisal) %>%
    mutate(whf = what-that) %>%
    select(-that, -what) %>%
    group_by(model, gap, region, gapsite, comp) %>%
      summarise(m=mean(whf),
              s=std.error(whf),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  mutate(region=as.numeric(region)) %>%
  filter(model == "JRNN") %>%
ggplot(aes(x=region, y=m, ymin=lower, ymax=upper, color=gap, linetype=gap)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_segment(data=annotations_subjgap, aes(x=x1,y=y1,yend=y2,xend=x2), color="blue", alpha=0.5, arrow = arrow(length = unit(0.2, "cm")),inherit.aes=FALSE) +
    geom_segment(data=annotations_objgap, aes(x=x1,y=y1,yend=y2,xend=x2), color="blue", alpha=0.5, arrow = arrow(length = unit(0.2, "cm")),inherit.aes=FALSE) +
    geom_label(data=text_annotations, aes(x=x, y=x, label=text), size=3, color="blue", inherit.aes=FALSE) +
    geom_line(size=1 ) +
    geom_errorbar(linetype="solid", width=.1, alpha=0.5) +
    scale_color_manual(values = c("#f8766d", "#00bfc4")) +
    scale_x_continuous(breaks=seq(1, NUM_REGIONS), labels=REGION_EXEMPLARS) +
    facet_grid(comp~gapsite)+
    ylab("Mean Wh-Effect in Region") +
    xlab("Gap Location") +
    ggtitle("That Trace Effects (JRNN)") +
    theme(legend.position="right", 
          axis.text=element_text(size=10),
          axis.text.x= element_text(angle=45, hjust=1),
          axis.title=element_text(size=12),
          legend.title=element_blank())
ggsave("./images/that-trace-region.pdf",height=4.5,width=7, device = cairo_pdf)

```


```{r}

dlm = df_trace %>%
  filter(gapsite == "subj") %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1),
         comp = if_else(comp == "thatcomp", 1, -1)) %>%
  filter(model == "JRNN") %>%
  lmer(surprisal~gap*wh*comp+(wh+gap+comp||item), data = .)
summary(dlm)

dlm = df_trace %>%
  filter(gapsite == "subj") %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1),
         comp = if_else(comp == "thatcomp", 1, -1)) %>%
  filter(model == "GRNN") %>%
  lmer(surprisal~gap*wh*comp+(wh+gap+comp||item), data = .)
summary(dlm)

dlm = df_trace %>%
  filter(gapsite == "subj") %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1),
         comp = if_else(comp == "thatcomp", 1, -1)) %>%
  filter(model == "GPT2") %>%
  lmer(surprisal~gap*wh*comp+(wh+gap+comp||item), data = .)
summary(dlm)

dlm = df_trace %>%
  filter(gapsite == "subj") %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(wh == "what", 1, -1),
         comp = if_else(comp == "thatcomp", 1, -1)) %>%
  filter(model == "GPT3") %>%
  lmer(surprisal~gap*wh*comp+(wh+gap+comp||item), data = .)
summary(dlm)

```

## Parasitic Gaps

```{r}
df_parasitic = df %>%
  filter(test == "parasitic-gaps") %>%
  separate(condition, sep="_", into=c("that", "gap", "tense")) %>%
  gather(model, surprisal, 9:13) %>%
  filter(region == "continuation") %>%
  group_by(that, gap, tense, model, item) %>%
    summarise(surprisal = mean(surprisal)) %>%
  ungroup()


df_parasitic %>%
  spread(that, surprisal) %>%
  mutate(whef = what-that) %>% #These are both +gap conditions, so we should see negative effects. In the +hostgap condition.
  select(-that, -what) %>%
    group_by(model, item) %>%
      mutate(item_mean=mean(whef)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, gap, tense) %>%
      summarise(m=mean(whef),
              s=std.error(whef - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
ggplot(aes(x=tense, y=m, ymin=lower, ymax=upper, fill=gap)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    scale_x_discrete(labels= c("gerund", "past tense")) +
    ylab("Wh-Effect") +
    xlab("Adjunct Tense") +
    ggtitle("Parasitic Gaps") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title=element_text(size=12),
          legend.title=element_blank())
ggsave("./images/parasitic.pdf",height=3,width=10, device = cairo_pdf)
```

```{r}
df_parasitic %>%
    group_by(model, item) %>%
      mutate(item_mean=mean(surprisal)) %>%
    ungroup() %>%
  drop_na() %>%
    group_by(model, gap, tense, that) %>%
      summarise(m=mean(surprisal),
              s=std.error(surprisal - item_mean),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
ggplot(aes(x=that, y=m, ymin=lower, ymax=upper, fill=gap)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_bar(stat="identity", position="dodge") +
    geom_errorbar(color="black", width=.5, position=position_dodge(width=.9)) +
    facet_grid(tense~model) +
    scale_fill_manual(labels = c("+gap", "-gap"), values = c("#00bfc4", "#f8766d")) +
    #scale_x_discrete(labels= c("gerund", "past tense")) +
    ylab("Wh-Effect") +
    xlab("Adjunct Tense") +
    ggtitle("Parasitic Gaps") +
    theme(legend.position="right", 
          axis.text=element_text(size=12),
          axis.title=element_text(size=12),
          legend.title=element_blank())
#ggsave("./images/parasitic.pdf",height=3,width=10, device = cairo_pdf)

```


```{r}
REGION_ORDER = c("prefix", "wh", "verb1", "host", "verb2", "adjunct_object", "continuation")
REGION_EXEMPLARS = c("I know", "wh/that", "you read", "the document", "before she shredded \n before shredding", "", "last night")
NUM_REGIONS = length(REGION_ORDER)

df_parasitic_region = df %>%
  filter(test == "parasitic-gaps") %>%
  separate(condition, sep="_", into=c("that", "gap", "tense")) %>%
  mutate(region = factor(region, levels = REGION_ORDER)) %>%
  gather(model, surprisal, 9:13) %>%
  group_by(that, gap, tense, model, item, region) %>%
    summarise(surprisal = sum(surprisal)) %>%
  ungroup() %>%
  mutate(gap=factor(gap, levels=c("nogap", "gap"), labels = c("no host gap", "host gap")),
         tense=factor(tense, levels=c("ger", "tense"), labels = c("gerund adjunct", "past-tense adjunct")))

annotations = data.frame(x1=c(6.75), x2=c(7.25), y1=c(-2), y2=c(1))


df_parasitic_region %>%
    spread(that, surprisal) %>%
    mutate(whf = what-that) %>%
    select(-that, -what) %>%
    group_by(model, gap, region, tense) %>%
      summarise(m=mean(whf),
              s=std.error(whf),
              upper=m + 1.96*s,
              lower=m - 1.96*s) %>%
    ungroup() %>%
  mutate(region=as.numeric(region)) %>%
  filter(model != "NGRAM") %>%
ggplot(aes(x=region, y=m, ymin=lower, ymax=upper, color=gap, linetype=gap)) +
    theme_bw() +
    geom_hline(yintercept=0, color="grey") +
    geom_rect(data=annotations, aes(xmin=x1, xmax=x2, ymin=y1,ymax=y2), fill="#14fcf0", alpha=0.3, size=0.1, inherit.aes=FALSE) +
    geom_line(size=1 ) +
    geom_errorbar(linetype="solid", width=.1, alpha=0.5) +
    scale_color_manual(values = c("#f8766d", "#00bfc4")) +
    #scale_color_manual(values = c("#00bfc4", "#00bfc4")) +
    scale_x_continuous(breaks=seq(1, NUM_REGIONS), labels=REGION_EXEMPLARS) +
    facet_grid(tense~model)+
    ylab("Mean Wh-Effect in Region") +
    xlab("Gap Location") +
    ggtitle("Parasitic Gaps") +
    theme(legend.position="bottom", 
          axis.text=element_text(size=8),
          axis.text.x= element_text(angle=45, hjust=1),
          axis.title=element_text(size=12),
          legend.title=element_blank())
ggsave("./images/parasitic-region.pdf",height=4.5,width=7, device = cairo_pdf)

```

```{r}

stats_test = function(df) {
  df %>%
    summarise(
      e = summary(lmer(surprisal~that*gap+(1|item), data = df))$coefficients[4],
      p = summary(lmer(surprisal~that*gap+(1|item), data = df))$coefficients[20])
  }

df_parasitic %>%
  mutate(gap = if_else(gap == "gap", 1, -1),
         wh = if_else(that == "what", 1, -1)) %>%
  group_by(model, tense) %>%
    do(stats_test(.)) %>%
  arrange(model) %>%
ungroup()


```

## Controls for Island Tests -- Different Number of Verbs

For the unigrams.txt corpus, download from http://norvig.com/ngrams/

```{r}
island_freq = read.csv("../data/freq_check.csv") %>%
  gather(cond, verb, c("Control", "Island"))

unigrams = read.csv("/Users/wilcoxeg/Documents/resources/data/trillion_word_corpus/unigrams.txt", sep="\t") %>%
  rename(verb = word)

freq_df = merge(island_freq, unigrams, by=("verb")) %>%
  mutate(count = log(count))

isl_df_cnp = freq_df %>% filter(cond == "Island", Test == "CNP")
control_df_cnp = freq_df %>% filter(cond == "Control", Test == "CNP")
t.test(isl_df_cnp$count, control_df_cnp$count)
    
isl_df_subj = freq_df %>% filter(cond == "Island", Test == "Subject")
control_df_subj = freq_df %>% filter(cond == "Control", Test == "Subject")
t.test(isl_df_subj$count, control_df_subj$count)

```




